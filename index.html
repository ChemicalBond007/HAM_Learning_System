<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业余无线电台A类题库练习</title>
    <style>
        /* --- 页面整体样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 25px;
        }

        /* --- 控制区域样式 --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .btn {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary { background-color: #3949ab; color: white; }
        .btn-primary:hover { background-color: #283593; }

        .btn-secondary { background-color: #546e7a; color: white; }
        .btn-secondary:hover { background-color: #455a64; }
        
        .btn-info { background-color: #0288d1; color: white; }
        .btn-info:hover { background-color: #0277bd; }

        .btn-danger { background-color: #d32f2f; color: white; }
        .btn-danger:hover { background-color: #c62828; }

        .btn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }

        /* --- 答题区域样式 --- */
        .quiz-area {
            display: none; /* 默认隐藏 */
        }

        #progress {
            font-size: 14px;
            color: #555;
            text-align: right;
            margin-bottom: 15px;
        }

        #question {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .question-type {
            color: #3949ab;
            font-weight: bold;
            font-size: 16px;
            margin-right: 10px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option {
            display: block;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .option input {
            margin-right: 12px;
            transform: scale(1.2);
            vertical-align: middle;
        }

        .option:hover {
            background-color: #e8eaf6;
            border-color: #3949ab;
        }

        .option.correct { background-color: #e8f5e9; border-color: #4caf50; font-weight: bold; }
        .option.incorrect { background-color: #ffebee; border-color: #f44336; }

        #feedback {
            margin-top: 20px; padding: 15px; border-radius: 6px;
            font-size: 16px; font-weight: bold; text-align: center;
        }
        .feedback-correct { background-color: #4caf50; color: white; }
        .feedback-incorrect { background-color: #f44336; color: white; }

        .actions {
            margin-top: 25px; display: flex; justify-content: center;
        }
        
        .hidden { display: none; }

        /* --- 新增：题库查看视图样式 --- */
        .list-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #list-view-title {
            color: #1a237e;
            margin: 0;
        }
        #list-view-content {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 15px;
        }
        .list-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 0;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item-question {
            font-size: 17px;
            font-weight: 500;
            margin: 0 0 10px 0;
        }
        .list-item-options p {
            margin: 5px 0 5px 20px;
            color: #555;
        }
        .list-item-answer {
            margin-top: 10px;
            font-weight: bold;
            color: #4caf50;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- 主视图 -->
        <div id="main-view">
            <h1>业余无线电台A类题库练习</h1>
            <div class="controls" id="controls">
                <button id="start-sequential-btn" class="btn btn-primary" disabled>顺序练习</button>
                <button id="start-random-btn" class="btn btn-primary" disabled>随机练习</button>
                <button id="start-wrong-btn" class="btn btn-secondary" disabled>练习错题</button>
                <button id="view-all-btn" class="btn btn-info" disabled>查看题库</button>
                <button id="view-wrong-btn" class="btn btn-info" disabled>查看错题</button>
                <button id="reset-wrong-btn" class="btn btn-danger">清空错题记录</button>
            </div>
            <div id="status-message" style="text-align: center; padding: 10px; color: #555;">正在加载题库...</div>
        </div>

        <!-- 答题视图 -->
        <div class="quiz-area" id="quiz-area">
            <div id="progress"></div>
            <h2 id="question"></h2>
            <div class="options" id="options"></div>
            <div id="feedback" class="hidden"></div>
            <div class="actions">
                <button id="check-btn" class="btn btn-primary">核对答案</button>
                <button id="next-btn" class="btn btn-primary hidden">下一题</button>
            </div>
        </div>

        <!-- 题库查看视图 -->
        <div id="list-view" class="hidden">
            <div class="list-view-header">
                <h2 id="list-view-title"></h2>
                <button id="back-to-menu-btn" class="btn btn-primary">返回主菜单</button>
            </div>
            <div id="list-view-content"></div>
        </div>
    </div>

    <script>
        // --- DOM 元素获取 ---
        const mainView = document.getElementById('main-view');
        const quizAreaDiv = document.getElementById('quiz-area');
        const listView = document.getElementById('list-view');
        const statusMessage = document.getElementById('status-message');

        const startSequentialBtn = document.getElementById('start-sequential-btn');
        const startRandomBtn = document.getElementById('start-random-btn');
        const startWrongBtn = document.getElementById('start-wrong-btn');
        const resetWrongBtn = document.getElementById('reset-wrong-btn');
        const viewAllBtn = document.getElementById('view-all-btn');
        const viewWrongBtn = document.getElementById('view-wrong-btn');
        
        const progressText = document.getElementById('progress');
        const questionText = document.getElementById('question');
        const optionsDiv = document.getElementById('options');
        const feedbackDiv = document.getElementById('feedback');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');

        const listViewTitle = document.getElementById('list-view-title');
        const listViewContent = document.getElementById('list-view-content');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');

        // --- 状态变量 ---
        let allQuestions = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let wrongQuestionIds = new Set();
        const WRONG_QUESTIONS_KEY = 'amateurRadioWrongQuestions_A_Class';

        // --- 函数定义 ---

        function loadWrongQuestions() {
            const saved = localStorage.getItem(WRONG_QUESTIONS_KEY);
            if (saved) {
                wrongQuestionIds = new Set(JSON.parse(saved));
            }
            updateWrongButtons();
        }

        function saveWrongQuestions() {
            localStorage.setItem(WRONG_QUESTIONS_KEY, JSON.stringify(Array.from(wrongQuestionIds)));
            updateWrongButtons();
        }
        
        function updateWrongButtons() {
            const count = wrongQuestionIds.size;
            startWrongBtn.textContent = `练习错题 (${count})`;
            viewWrongBtn.textContent = `查看错题 (${count})`;
            startWrongBtn.disabled = count === 0;
            viewWrongBtn.disabled = count === 0;
        }

        async function loadQuestions() {
            try {
                const response = await fetch('QuestionLib.json'); // <-- 文件名已修改
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allQuestions = await response.json();
                statusMessage.textContent = `题库加载成功！共 ${allQuestions.length} 题。`;
                startSequentialBtn.disabled = false;
                startRandomBtn.disabled = false;
                viewAllBtn.disabled = false;
            } catch (error) {
                // <-- 错误提示中的文件名已同步修改
                statusMessage.innerHTML = `<strong>题库加载失败！</strong><br>请确保 'QuestionLib.json' 文件与此HTML文件在同一目录下。<br>错误信息: ${error.message}`;
                console.error("Failed to load questions:", error);
            }
        }

        function startQuiz(mode) {
            currentQuestionIndex = 0;
            switch(mode) {
                case 'sequential': currentQuestions = [...allQuestions]; break;
                case 'random': currentQuestions = [...allQuestions].sort(() => Math.random() - 0.5); break;
                case 'wrong':
                    if (wrongQuestionIds.size === 0) { alert("没有错题可以练习！"); return; }
                    currentQuestions = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
                    break;
            }
            if (currentQuestions.length === 0) { alert("没有题目可以练习！"); return; }
            mainView.classList.add('hidden');
            quizAreaDiv.style.display = 'block';
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) { showSummary(); return; }
            feedbackDiv.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            checkBtn.disabled = false;

            const question = currentQuestions[currentQuestionIndex];
            const isMultiChoice = question.TrueAnswer.length > 1;
            const questionTypeTag = isMultiChoice ? '[多选题]' : '[单选题]';
            const inputType = isMultiChoice ? 'checkbox' : 'radio';

            progressText.textContent = `进度: ${currentQuestionIndex + 1} / ${currentQuestions.length}`;
            questionText.innerHTML = `<span class="question-type">${questionTypeTag}</span>${question.Question}`;
            
            optionsDiv.innerHTML = '';
            for (const key in question.Options) {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option';
                const input = document.createElement('input');
                input.type = inputType;
                input.name = 'option';
                input.value = key;
                optionLabel.appendChild(input);
                optionLabel.appendChild(document.createTextNode(` ${key}. ${question.Options[key]}`));
                optionsDiv.appendChild(optionLabel);
            }
        }

        function checkAnswer() {
            const selectedOptions = Array.from(optionsDiv.querySelectorAll('input:checked')).map(input => input.value);
            const userAnswer = selectedOptions.sort().join('');
            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question.TrueAnswer.split('').sort().join('');
            const isCorrect = userAnswer === correctAnswer;

            feedbackDiv.classList.remove('hidden');
            if (isCorrect) {
                feedbackDiv.textContent = '回答正确！';
                feedbackDiv.className = 'feedback-correct';
                if (wrongQuestionIds.has(question.J_ID)) wrongQuestionIds.delete(question.J_ID);
            } else {
                feedbackDiv.innerHTML = `回答错误！正确答案是: <strong>${question.TrueAnswer}</strong>`;
                feedbackDiv.className = 'feedback-incorrect';
                wrongQuestionIds.add(question.J_ID);
            }
            saveWrongQuestions();
            highlightAnswers(correctAnswer);
            checkBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            optionsDiv.querySelectorAll('input').forEach(input => input.disabled = true);
        }

        function highlightAnswers(correctAnswer) {
            optionsDiv.querySelectorAll('.option').forEach(label => {
                const input = label.querySelector('input');
                if (correctAnswer.includes(input.value)) label.classList.add('correct');
                else if (input.checked) label.classList.add('incorrect');
            });
        }

        function showSummary() {
            quizAreaDiv.style.display = 'none';
            mainView.classList.remove('hidden');
            statusMessage.textContent = `练习完成！本次共练习 ${currentQuestions.length} 题。`;
        }

        function displayListView(mode) {
            let questionsToDisplay;
            if (mode === 'all') {
                listViewTitle.textContent = '全部题库';
                questionsToDisplay = allQuestions;
            } else { // mode === 'wrong'
                listViewTitle.textContent = '我的错题集';
                questionsToDisplay = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
            }

            if (questionsToDisplay.length === 0) {
                listViewContent.innerHTML = '<p style="text-align:center; color:#777; padding: 20px 0;">这里是空的！</p>';
            } else {
                const htmlContent = questionsToDisplay.map((q, index) => {
                    const isMultiChoice = q.TrueAnswer.length > 1;
                    const questionTypeTag = isMultiChoice ? '[多选题]' : '[单选题]';
                    const optionsHtml = Object.entries(q.Options).map(([key, value]) => `<p>${key}. ${value}</p>`).join('');
                    return `
                        <div class="list-item">
                            <p class="list-item-question"><strong>${index + 1}. </strong><span class="question-type">${questionTypeTag}</span>${q.Question}</p>
                            <div class="list-item-options">${optionsHtml}</div>
                            <p class="list-item-answer">正确答案: ${q.TrueAnswer}</p>
                        </div>`;
                }).join('');
                listViewContent.innerHTML = htmlContent;
            }
            mainView.classList.add('hidden');
            listView.classList.remove('hidden');
        }

        function hideListView() {
            listView.classList.add('hidden');
            mainView.classList.remove('hidden');
        }

        // --- 事件监听器 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadWrongQuestions();
            loadQuestions();
        });

        startSequentialBtn.addEventListener('click', () => startQuiz('sequential'));
        startRandomBtn.addEventListener('click', () => startQuiz('random'));
        startWrongBtn.addEventListener('click', () => startQuiz('wrong'));
        viewAllBtn.addEventListener('click', () => displayListView('all'));
        viewWrongBtn.addEventListener('click', () => displayListView('wrong'));
        backToMenuBtn.addEventListener('click', hideListView);

        resetWrongBtn.addEventListener('click', () => {
            if (confirm('确定要清空所有错题记录吗？此操作不可恢复。')) {
                wrongQuestionIds.clear();
                saveWrongQuestions();
                alert('错题记录已清空。');
            }
        });

        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            displayQuestion();
        });
    </script>
</body>
</html>