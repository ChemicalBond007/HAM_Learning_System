<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业余无线电台题库练习</title>
    <link rel="icon" type="image/jpeg" href="HAM.jpeg">
    <style>
        /* --- 页面整体样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* --- 语言切换器 --- */
        #lang-switcher {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #546e7a;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            z-index: 10;
        }
        #lang-switcher:hover {
            background-color: #eceff1;
        }

        h1, h2 {
            text-align: center;
            color: #1a237e;
        }
        h1 { margin-bottom: 25px; padding-top: 20px; }

        /* --- 按钮样式 --- */
        .btn {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .btn-large { padding: 15px 30px; font-size: 18px; }
        .btn-primary { background-color: #3949ab; color: white; }
        .btn-primary:hover { background-color: #283593; }
        .btn-secondary { background-color: #546e7a; color: white; }
        .btn-secondary:hover { background-color: #455a64; }
        .btn-info { background-color: #0288d1; color: white; }
        .btn-info:hover { background-color: #0277bd; }
        .btn-danger { background-color: #d32f2f; color: white; }
        .btn-danger:hover { background-color: #c62828; }
        .btn:disabled { background-color: #bdbdbd; cursor: not-allowed; }

        /* --- 视图通用 --- */
        .view { display: none; }
        .hidden { display: none; }

        /* --- 题库选择视图 --- */
        #library-selection-view .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin-top: 30px;
        }

        /* --- 主练习视图 --- */
        #main-view .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* --- 答题与列表视图通用样式 --- */
        #progress { font-size: 14px; color: #555; text-align: right; margin-bottom: 15px; }
        #question { font-size: 20px; font-weight: 600; margin-bottom: 20px; line-height: 1.6; }
        .question-type { color: #3949ab; font-weight: bold; font-size: 16px; margin-right: 10px; }
        .options { display: flex; flex-direction: column; gap: 15px; }
        .option { display: block; padding: 15px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .option input { margin-right: 12px; transform: scale(1.2); vertical-align: middle; }
        .option:hover { background-color: #e8eaf6; border-color: #3949ab; }
        .option.correct { background-color: #e8f5e9; border-color: #4caf50; font-weight: bold; }
        .option.incorrect { background-color: #ffebee; border-color: #f44336; }
        #feedback { margin-top: 20px; padding: 15px; border-radius: 6px; font-size: 16px; font-weight: bold; text-align: center; }
        .feedback-correct { background-color: #4caf50; color: white; }
        .feedback-incorrect { background-color: #f44336; color: white; }
        .actions { margin-top: 25px; display: flex; justify-content: center; }
        .list-view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #list-view-content { max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        .list-item { border-bottom: 1px solid #e0e0e0; padding: 15px 0; }
        .list-item:last-child { border-bottom: none; }
        .list-item-question { font-size: 17px; font-weight: 500; margin: 0 0 10px 0; }
        .list-item-options p { margin: 5px 0 5px 20px; color: #555; }
        .list-item-answer { margin-top: 10px; font-weight: bold; color: #4caf50; }
    </style>
</head>
<body>

    <div class="container">
        <button id="lang-switcher"></button>
        
        <!-- 题库选择视图 -->
        <div id="library-selection-view" class="view">
            <h1 id="selection-title"></h1>
            <div class="controls">
                <button class="btn btn-large btn-primary" data-key="A"></button>
                <button class="btn btn-large btn-primary" data-key="B"></button>
                <button class="btn btn-large btn-primary" data-key="C"></button>
                <button class="btn btn-large btn-secondary" data-key="Main"></button>
            </div>
        </div>

        <!-- 主练习视图 -->
        <div id="main-view" class="view">
            <h1 id="main-title"></h1>
            <div class="controls">
                <button id="start-sequential-btn" class="btn btn-primary" disabled></button>
                <button id="start-random-btn" class="btn btn-primary" disabled></button>
                <button id="start-wrong-btn" class="btn btn-secondary" disabled></button>
                <button id="view-all-btn" class="btn btn-info" disabled></button>
                <button id="view-wrong-btn" class="btn btn-info" disabled></button>
                <button id="reset-wrong-btn" class="btn btn-danger"></button>
                <button id="change-library-btn" class="btn btn-secondary"></button>
            </div>
            <div id="status-message" style="text-align: center; padding: 10px; color: #555;"></div>
        </div>

        <!-- 答题视图 -->
        <div id="quiz-area" class="view">
            <div id="progress"></div>
            <h2 id="question"></h2>
            <div class="options" id="options"></div>
            <div id="feedback" class="hidden"></div>
            <div class="actions">
                <button id="check-btn" class="btn btn-primary"></button>
                <button id="next-btn" class="btn btn-primary hidden"></button>
            </div>
        </div>

        <!-- 列表查看视图 -->
        <div id="list-view" class="view">
            <div class="list-view-header">
                <h2 id="list-view-title"></h2>
                <button id="back-to-menu-btn" class="btn btn-primary"></button>
            </div>
            <div id="list-view-content"></div>
        </div>
    </div>

    <script>
        // --- 配置与翻译 ---
        const LIBRARIES = {
            'A': { file: 'A-ClassQuestionLib.json', name: { zh: 'A类题库', en: 'A-Class Library' } },
            'B': { file: 'B-ClassQuestionLib.json', name: { zh: 'B类题库', en: 'B-Class Library' } },
            'C': { file: 'C-ClassQuestionLib.json', name: { zh: 'C类题库', en: 'C-Class Library' } },
            'Main': { file: 'MainQuestionLib.json', name: { zh: '总题库', en: 'Main Library' } }
        };

        const translations = {
            zh: {
                lang: 'zh-CN', langToggle: 'English',
                selectionTitle: '请选择题库',
                mainTitle: libName => `业余无线电台 ${libName} 练习`,
                seqButton: '顺序练习', randomButton: '随机练习',
                practiceWrongButton: c => `练习错题 (${c})`,
                viewAllButton: '查看题库', viewWrongButton: c => `查看错题 (${c})`,
                resetWrongButton: '清空错题记录', changeLibraryButton: '切换题库',
                loading: '正在加载题库...', loadSuccess: c => `题库加载成功！共 ${c} 题。`,
                loadFail: file => `<strong>题库 '${file}' 加载失败！</strong><br>请确保文件存在且与HTML文件在同一目录下。`,
                progress: (cur, total) => `进度: ${cur} / ${total}`,
                singleChoice: '[单选题]', multiChoice: '[多选题]',
                checkAnswer: '核对答案', nextQuestion: '下一题',
                correct: '回答正确！', incorrect: ans => `回答错误！正确答案是: <strong>${ans}</strong>`,
                quizComplete: c => `练习完成！本次共练习 ${c} 题。`,
                allQuestionsTitle: '全部题库', wrongQuestionsTitle: '我的错题集',
                emptyList: '这里是空的！', backToMenu: '返回主菜单',
                correctAnswerLabel: '正确答案',
                confirmReset: '确定要清空当前题库的错题记录吗？此操作不可恢复。',
                resetSuccess: '错题记录已清空。',
                noWrongQuestions: '没有错题可以练习！', noQuestions: '没有题目可以练习！'
            },
            en: {
                lang: 'en', langToggle: '中文',
                selectionTitle: 'Please Select a Library',
                mainTitle: libName => `Amateur Radio ${libName} Quiz`,
                seqButton: 'Sequential Practice', randomButton: 'Random Practice',
                practiceWrongButton: c => `Practice Mistakes (${c})`,
                viewAllButton: 'View Question Bank', viewWrongButton: c => `View Mistakes (${c})`,
                resetWrongButton: 'Clear Mistake Log', changeLibraryButton: 'Change Library',
                loading: 'Loading question bank...', loadSuccess: c => `Successfully loaded ${c} questions.`,
                loadFail: file => `<strong>Failed to load '${file}'!</strong><br>Please ensure the file exists in the same directory.`,
                progress: (cur, total) => `Progress: ${cur} / ${total}`,
                singleChoice: '[Single Choice]', multiChoice: '[Multiple Choice]',
                checkAnswer: 'Check Answer', nextQuestion: 'Next Question',
                correct: 'Correct!', incorrect: ans => `Incorrect! The correct answer is: <strong>${ans}</strong>`,
                quizComplete: c => `Practice complete! You attempted ${c} questions.`,
                allQuestionsTitle: 'Full Question Bank', wrongQuestionsTitle: 'My Mistakes',
                emptyList: 'Nothing to show here!', backToMenu: 'Back to Menu',
                correctAnswerLabel: 'Correct Answer',
                confirmReset: 'Are you sure you want to clear the mistake log for the current library? This cannot be undone.',
                resetSuccess: 'Mistake log has been cleared.',
                noWrongQuestions: 'No mistakes to practice!', noQuestions: 'No questions to practice!'
            }
        };

        // --- DOM 元素 ---
        const allViews = document.querySelectorAll('.view');
        const langSwitcher = document.getElementById('lang-switcher');
        const librarySelectionView = document.getElementById('library-selection-view');
        const mainView = document.getElementById('main-view');
        const quizArea = document.getElementById('quiz-area');
        const listView = document.getElementById('list-view');
        // ... (other elements are selected inside functions where needed)

        // --- 状态变量 ---
        let allQuestions = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let wrongQuestionIds = new Set();
        let currentLang = 'zh';
        let currentLibraryKey = null;
        const LANG_KEY = 'amateurRadioQuizLang';
        const LAST_LIBRARY_KEY = 'amateurRadioLastLibrary';
        const WRONG_QUESTIONS_KEY_PREFIX = 'amateurRadioWrongQuestions_';

        // --- 核心函数 ---

        function showView(viewToShow) {
            allViews.forEach(v => v.style.display = 'none');
            viewToShow.style.display = 'block';
        }

        function setLanguage(lang, isInitial = false) {
            currentLang = lang;
            const t = translations[lang];
            
            document.documentElement.lang = t.lang;
            document.title = t.selectionTitle; // Default title
            langSwitcher.textContent = t.langToggle;

            // Update selection view
            document.getElementById('selection-title').textContent = t.selectionTitle;
            document.querySelectorAll('#library-selection-view .btn').forEach(btn => {
                const key = btn.dataset.key;
                btn.textContent = LIBRARIES[key].name[lang];
            });

            // Update main view (if a library is selected)
            if (currentLibraryKey) {
                document.title = t.mainTitle(LIBRARIES[currentLibraryKey].name[lang]);
                document.getElementById('main-title').textContent = t.mainTitle(LIBRARIES[currentLibraryKey].name[lang]);
                document.getElementById('start-sequential-btn').textContent = t.seqButton;
                document.getElementById('start-random-btn').textContent = t.randomButton;
                document.getElementById('reset-wrong-btn').textContent = t.resetWrongButton;
                document.getElementById('view-all-btn').textContent = t.viewAllButton;
                document.getElementById('change-library-btn').textContent = t.changeLibraryButton;
                updateWrongButtons();
            }
            
            // Update other static texts
            document.getElementById('check-btn').textContent = t.checkAnswer;
            document.getElementById('next-btn').textContent = t.nextQuestion;
            document.getElementById('back-to-menu-btn').textContent = t.backToMenu;

            // Update status message if it's not showing a failure
            const statusMessage = document.getElementById('status-message');
            if (!isInitial && statusMessage.textContent && !statusMessage.innerHTML.includes('<strong>')) {
                if (allQuestions.length > 0) {
                    statusMessage.textContent = t.loadSuccess(allQuestions.length);
                }
            }
        }

        function selectLibrary(key) {
            currentLibraryKey = key;
            localStorage.setItem(LAST_LIBRARY_KEY, key);
            allQuestions = []; // Reset questions
            
            // ***** FIX STARTS HERE *****
            // Call setLanguage to update all UI text for the newly selected library.
            // This ensures all buttons get their text content immediately.
            setLanguage(currentLang);
            // ***** FIX ENDS HERE *****

            // Disable buttons until loaded
            document.querySelectorAll('#main-view .btn').forEach(b => b.disabled = true);
            document.getElementById('reset-wrong-btn').disabled = false;
            document.getElementById('change-library-btn').disabled = false;

            showView(mainView);
            loadWrongQuestions(); // Load mistakes for this specific library
            loadQuestions();
        }

        function loadWrongQuestions() {
            const key = WRONG_QUESTIONS_KEY_PREFIX + currentLibraryKey;
            const saved = localStorage.getItem(key);
            wrongQuestionIds = saved ? new Set(JSON.parse(saved)) : new Set();
            updateWrongButtons();
        }

        function saveWrongQuestions() {
            const key = WRONG_QUESTIONS_KEY_PREFIX + currentLibraryKey;
            localStorage.setItem(key, JSON.stringify(Array.from(wrongQuestionIds)));
            updateWrongButtons();
        }
        
        function updateWrongButtons() {
            const count = wrongQuestionIds.size;
            const t = translations[currentLang];
            const startWrongBtn = document.getElementById('start-wrong-btn');
            const viewWrongBtn = document.getElementById('view-wrong-btn');
            startWrongBtn.textContent = t.practiceWrongButton(count);
            viewWrongBtn.textContent = t.viewWrongButton(count);
            startWrongBtn.disabled = count === 0;
            viewWrongBtn.disabled = count === 0;
        }

        async function loadQuestions() {
            const statusMessage = document.getElementById('status-message');
            const t = translations[currentLang];
            const library = LIBRARIES[currentLibraryKey];
            statusMessage.textContent = t.loading;

            try {
                const response = await fetch(library.file);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allQuestions = await response.json();
                statusMessage.textContent = t.loadSuccess(allQuestions.length);
                document.getElementById('start-sequential-btn').disabled = false;
                document.getElementById('start-random-btn').disabled = false;
                document.getElementById('view-all-btn').disabled = false;
            } catch (error) {
                statusMessage.innerHTML = t.loadFail(library.file);
                console.error("Failed to load questions:", error);
            }
        }

        function startQuiz(mode) {
            const t = translations[currentLang];
            currentQuestionIndex = 0;
            switch(mode) {
                case 'sequential': currentQuestions = [...allQuestions]; break;
                case 'random': currentQuestions = [...allQuestions].sort(() => Math.random() - 0.5); break;
                case 'wrong':
                    if (wrongQuestionIds.size === 0) { alert(t.noWrongQuestions); return; }
                    currentQuestions = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
                    break;
            }
            if (currentQuestions.length === 0) { alert(t.noQuestions); return; }
            showView(quizArea);
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) { showSummary(); return; }
            const t = translations[currentLang];
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('check-btn').disabled = false;

            const question = currentQuestions[currentQuestionIndex];
            const isMultiChoice = question.TrueAnswer.length > 1;
            const questionTypeTag = isMultiChoice ? t.multiChoice : t.singleChoice;
            const inputType = isMultiChoice ? 'checkbox' : 'radio';

            document.getElementById('progress').textContent = t.progress(currentQuestionIndex + 1, currentQuestions.length);
            document.getElementById('question').innerHTML = `<span class="question-type">${questionTypeTag}</span>${question.Question}`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            for (const key in question.Options) {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option';
                const input = document.createElement('input');
                input.type = inputType; input.name = 'option'; input.value = key;
                optionLabel.appendChild(input);
                optionLabel.appendChild(document.createTextNode(` ${key}. ${question.Options[key]}`));
                optionsDiv.appendChild(optionLabel);
            }
        }

        function checkAnswer() {
            const t = translations[currentLang];
            const selectedOptions = Array.from(document.querySelectorAll('#options input:checked')).map(input => input.value);
            const userAnswer = selectedOptions.sort().join('');
            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question.TrueAnswer.split('').sort().join('');
            const isCorrect = userAnswer === correctAnswer;

            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.classList.remove('hidden');
            if (isCorrect) {
                feedbackDiv.textContent = t.correct;
                feedbackDiv.className = 'feedback-correct';
                if (wrongQuestionIds.has(question.J_ID)) wrongQuestionIds.delete(question.J_ID);
            } else {
                feedbackDiv.innerHTML = t.incorrect(question.TrueAnswer);
                feedbackDiv.className = 'feedback-incorrect';
                wrongQuestionIds.add(question.J_ID);
            }
            saveWrongQuestions();
            highlightAnswers(correctAnswer);
            document.getElementById('check-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
            document.querySelectorAll('#options input').forEach(input => input.disabled = true);
        }

        function highlightAnswers(correctAnswer) {
            document.querySelectorAll('#options .option').forEach(label => {
                const input = label.querySelector('input');
                if (correctAnswer.includes(input.value)) label.classList.add('correct');
                else if (input.checked) label.classList.add('incorrect');
            });
        }

        function showSummary() {
            showView(mainView);
            document.getElementById('status-message').textContent = translations[currentLang].quizComplete(currentQuestions.length);
        }

        function displayListView(mode) {
            const t = translations[currentLang];
            let questionsToDisplay;
            const listViewTitle = document.getElementById('list-view-title');
            if (mode === 'all') {
                listViewTitle.textContent = t.allQuestionsTitle;
                questionsToDisplay = allQuestions;
            } else {
                listViewTitle.textContent = t.wrongQuestionsTitle;
                questionsToDisplay = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
            }

            const listViewContent = document.getElementById('list-view-content');
            if (questionsToDisplay.length === 0) {
                listViewContent.innerHTML = `<p style="text-align:center; color:#777; padding: 20px 0;">${t.emptyList}</p>`;
            } else {
                listViewContent.innerHTML = questionsToDisplay.map((q, index) => {
                    const isMultiChoice = q.TrueAnswer.length > 1;
                    const questionTypeTag = isMultiChoice ? t.multiChoice : t.singleChoice;
                    const optionsHtml = Object.entries(q.Options).map(([key, value]) => `<p>${key}. ${value}</p>`).join('');
                    return `
                        <div class="list-item">
                            <p class="list-item-question"><strong>${index + 1}. </strong><span class="question-type">${questionTypeTag}</span>${q.Question}</p>
                            <div class="list-item-options">${optionsHtml}</div>
                            <p class="list-item-answer">${t.correctAnswerLabel}: ${q.TrueAnswer}</p>
                        </div>`;
                }).join('');
            }
            showView(listView);
        }

        // --- 事件监听器 ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem(LANG_KEY) || 'zh';
            setLanguage(savedLang, true);

            const savedLibrary = localStorage.getItem(LAST_LIBRARY_KEY);
            if (savedLibrary && LIBRARIES[savedLibrary]) {
                selectLibrary(savedLibrary);
            } else {
                showView(librarySelectionView);
            }
        });

        langSwitcher.addEventListener('click', () => {
            const newLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem(LANG_KEY, newLang);
            setLanguage(newLang);
        });

        document.querySelectorAll('#library-selection-view .btn').forEach(btn => {
            btn.addEventListener('click', () => selectLibrary(btn.dataset.key));
        });

        document.getElementById('change-library-btn').addEventListener('click', () => {
            currentLibraryKey = null;
            localStorage.removeItem(LAST_LIBRARY_KEY);
            showView(librarySelectionView);
        });

        document.getElementById('start-sequential-btn').addEventListener('click', () => startQuiz('sequential'));
        document.getElementById('start-random-btn').addEventListener('click', () => startQuiz('random'));
        document.getElementById('start-wrong-btn').addEventListener('click', () => startQuiz('wrong'));
        document.getElementById('view-all-btn').addEventListener('click', () => displayListView('all'));
        document.getElementById('view-wrong-btn').addEventListener('click', () => displayListView('wrong'));
        document.getElementById('back-to-menu-btn').addEventListener('click', () => showView(mainView));

        document.getElementById('reset-wrong-btn').addEventListener('click', () => {
            const t = translations[currentLang];
            if (confirm(t.confirmReset)) {
                wrongQuestionIds.clear();
                saveWrongQuestions();
                alert(t.resetSuccess);
            }
        });

        document.getElementById('check-btn').addEventListener('click', checkAnswer);
        document.getElementById('next-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            displayQuestion();
        });
    </script>
</body>
</html>