<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业余无线电台题库练习</title>
    <link rel="icon" type="image/jpeg" href="HAM.jpeg">
    <style>
        /* --- 页面整体样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 800px; background-color: #fff; padding: 25px 30px;
            border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative;
        }
        #lang-switcher {
            position: absolute; top: 15px; right: 20px; background: none; border: none;
            color: #546e7a; cursor: pointer; font-size: 14px; font-weight: 500;
            padding: 5px 10px; border-radius: 5px; transition: background-color 0.2s; z-index: 10;
        }
        #lang-switcher:hover { background-color: #eceff1; }
        h1, h2 { text-align: center; color: #1a237e; }
        h1 { margin-bottom: 25px; padding-top: 20px; }

        /* --- 按钮样式 --- */
        .btn {
            padding: 12px 20px; font-size: 16px; border: none; border-radius: 6px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 500;
        }
        .btn-large { padding: 15px 30px; font-size: 18px; }
        .btn-primary { background-color: #3949ab; color: white; }
        .btn-primary:hover { background-color: #283593; }
        .btn-secondary { background-color: #546e7a; color: white; }
        .btn-secondary:hover { background-color: #455a64; }
        .btn-info { background-color: #0288d1; color: white; }
        .btn-info:hover { background-color: #0277bd; }
        .btn-danger { background-color: #d32f2f; color: white; }
        .btn-danger:hover { background-color: #c62828; }
        .btn:disabled { background-color: #bdbdbd; cursor: not-allowed; }

        /* --- 视图通用 --- */
        .view { display: none; }
        .hidden { display: none; }

        /* --- 视图特定样式 --- */
        #library-selection-view .controls, #main-view .controls {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
        }
        #library-selection-view .controls { flex-direction: column; align-items: center; margin-top: 30px; gap: 20px; }
        #main-view .controls { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; }

        /* --- 答题/考试区域 --- */
        #question { font-size: 20px; font-weight: 600; margin-bottom: 20px; line-height: 1.6; }
        .question-type { color: #3949ab; font-weight: bold; font-size: 16px; margin-right: 10px; }
        .options { display: flex; flex-direction: column; gap: 15px; }
        .option { display: block; padding: 15px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .option input { margin-right: 12px; transform: scale(1.2); vertical-align: middle; }
        .option:hover { background-color: #e8eaf6; border-color: #3949ab; }
        .option.correct { background-color: #e8f5e9; border-color: #4caf50; font-weight: bold; }
        .option.incorrect { background-color: #ffebee; border-color: #f44336; }
        #feedback { margin-top: 20px; padding: 15px; border-radius: 6px; font-size: 16px; font-weight: bold; text-align: center; }
        .feedback-correct { background-color: #4caf50; color: white; }
        .feedback-incorrect { background-color: #f44336; color: white; }
        .actions { margin-top: 25px; display: flex; justify-content: space-between; align-items: center; }

        /* --- 进度与统计 --- */
        #progress-container {
            width: 100%; background-color: #e0e0e0; border-radius: 8px;
            height: 24px; position: relative; margin-bottom: 15px; overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background-color: #3949ab;
            border-radius: 8px; transition: width 0.4s ease-in-out;
        }
        #progress-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #stats-container {
            display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px 20px;
            margin-bottom: 25px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; font-size: 14px;
        }
        #stats-container span { font-weight: 500; }
        #stats-correct { color: #2e7d32; }
        #stats-incorrect { color: #c62828; }
        #exam-timer {
            font-size: 18px; font-weight: bold; color: #d32f2f; text-align: center; margin-bottom: 15px;
        }

        /* --- 列表/结果视图 --- */
        .list-view-header, .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #list-view-content { max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        .list-item { border-bottom: 1px solid #e0e0e0; padding: 15px 0; }
        .list-item:last-child { border-bottom: none; }
        .list-item-question { font-size: 17px; font-weight: 500; margin: 0 0 10px 0; }
        .list-item-options p { margin: 5px 0 5px 20px; color: #555; }
        .list-item-answer { margin-top: 10px; font-weight: bold; color: #4caf50; }
        #exam-result-view .result-summary { text-align: center; }
        #exam-result-view .result-status { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
        #exam-result-view .result-status.pass { color: #2e7d32; }
        #exam-result-view .result-status.fail { color: #c62828; }
        #exam-result-view .result-details { font-size: 18px; line-height: 1.8; }
    </style>
</head>
<body>

    <div class="container">
        <button id="lang-switcher"></button>
        
        <div id="library-selection-view" class="view">
            <h1 id="selection-title"></h1>
            <div class="controls">
                <button class="btn btn-large btn-primary" data-key="A"></button>
                <button class="btn btn-large btn-primary" data-key="B"></button>
                <button class="btn btn-large btn-primary" data-key="C"></button>
                <button class="btn btn-large btn-secondary" data-key="Main"></button>
            </div>
        </div>

        <div id="main-view" class="view">
            <h1 id="main-title"></h1>
            <div class="controls">
                <button id="start-sequential-btn" class="btn btn-primary" disabled></button>
                <button id="start-exam-btn" class="btn btn-primary" disabled></button>
                <button id="start-wrong-btn" class="btn btn-secondary" disabled></button>
                <button id="view-all-btn" class="btn btn-info" disabled></button>
                <button id="view-wrong-btn" class="btn btn-info" disabled></button>
                <button id="reset-wrong-btn" class="btn btn-danger"></button>
                <button id="change-library-btn" class="btn btn-secondary"></button>
            </div>
            <div id="status-message" style="text-align: center; padding: 10px; color: #555;"></div>
        </div>

        <div id="quiz-area" class="view">
            <div id="exam-timer" class="hidden"></div>
            <div id="progress-container" class="hidden">
                <div id="progress-bar"></div>
                <span id="progress-text">0%</span>
            </div>
            <div id="stats-container" class="hidden">
                <span id="stats-answered"></span>
                <span id="stats-remaining"></span>
                <span id="stats-correct"></span>
                <span id="stats-incorrect"></span>
            </div>
            <h2 id="question"></h2>
            <div class="options" id="options"></div>
            <div id="feedback" class="hidden"></div>
            <div class="actions">
                <div id="practice-actions" class="hidden" style="width:100%; display:flex; justify-content:space-between;">
                    <button id="practice-back-btn" class="btn btn-secondary"></button>
                    <div>
                        <button id="check-btn" class="btn btn-primary"></button>
                        <button id="next-btn" class="btn btn-primary hidden"></button>
                    </div>
                </div>
                <div id="exam-actions" class="hidden" style="width:100%; display:flex; justify-content:space-between;">
                    <button id="exam-prev-btn" class="btn btn-secondary"></button>
                    <button id="exam-submit-btn" class="btn btn-danger"></button>
                    <button id="exam-next-btn" class="btn btn-primary"></button>
                </div>
            </div>
        </div>

        <div id="list-view" class="view">
            <div class="list-view-header">
                <h2 id="list-view-title"></h2>
                <button id="back-to-menu-btn" class="btn btn-primary"></button>
            </div>
            <div id="list-view-content"></div>
        </div>

        <div id="exam-result-view" class="view">
            <h2 id="result-title"></h2>
            <div class="result-summary">
                <div id="result-status" class="result-status"></div>
                <div id="result-details" class="result-details"></div>
            </div>
            <div class="actions" style="justify-content: center; margin-top: 30px;">
                <button id="result-back-btn" class="btn btn-primary"></button>
            </div>
        </div>
    </div>

    <script>
        // --- 配置与翻译 ---
        const LIBRARIES = {
            'A': { file: 'A-ClassQuestionLib.json', name: { zh: 'A类题库', en: 'A-Class Library' } },
            'B': { file: 'B-ClassQuestionLib.json', name: { zh: 'B类题库', en: 'B-Class Library' } },
            'C': { file: 'C-ClassQuestionLib.json', name: { zh: 'C类题库', en: 'C-Class Library' } },
            'Main': { file: 'MainQuestionLib.json', name: { zh: '总题库', en: 'Main Library' } }
        };
        const EXAM_CONFIG = { DURATION: 40 * 60, TOTAL_QUESTIONS: 30, PASS_SCORE: 25 };

        const translations = {
            zh: {
                lang: 'zh-CN', langToggle: 'English', selectionTitle: '请选择题库',
                mainTitle: libName => `业余无线电台 ${libName} 练习`,
                seqButton: '顺序练习', examButton: '模拟考试', practiceWrongButton: c => `练习错题 (${c})`,
                viewAllButton: '查看题库', viewWrongButton: c => `查看错题 (${c})`,
                resetWrongButton: '清空错题记录', changeLibraryButton: '切换题库',
                loading: '正在加载题库...', loadSuccess: c => `题库加载成功！共 ${c} 题。`,
                loadFail: file => `<strong>题库 '${file}' 加载失败！</strong><br>请确保文件存在且与HTML文件在同一目录下。`,
                statsAnswered: c => `已答: ${c}`, statsRemaining: c => `未答: ${c}`,
                statsCorrect: c => `正确: ${c}`, statsIncorrect: c => `错误: ${c}`,
                singleChoice: '[单选题]', multiChoice: '[多选题]',
                checkAnswer: '核对答案', nextQuestion: '下一题',
                examPrev: '上一题', examNext: '下一题', examSubmit: '交卷',
                confirmSubmit: '确定要交卷吗？',
                timeRemaining: '剩余时间',
                examResultTitle: '考试结果', resultPass: '及格', resultFail: '不及格',
                resultDetails: (score, total, correct, incorrect, time) => `分数: ${score}/${total}<br>正确: ${correct} | 错误: ${incorrect}<br>用时: ${time}`,
                correct: '回答正确！', incorrect: ans => `回答错误！正确答案是: <strong>${ans}</strong>`,
                quizComplete: c => `练习完成！本次共练习 ${c} 题。`,
                allQuestionsTitle: '全部题库', wrongQuestionsTitle: '我的错题集',
                emptyList: '这里是空的！', backToMenu: '返回主菜单', practiceBackButton: '返回主菜单',
                correctAnswerLabel: '正确答案',
                confirmReset: '确定要清空当前题库的错题记录吗？此操作不可恢复。',
                resetSuccess: '错题记录已清空。',
                noWrongQuestions: '没有错题可以练习！', noQuestions: '没有题目可以练习！',
                notEnoughQuestions: total => `题库题目不足 ${total} 道，无法进行模拟考试。`
            },
            en: {
                lang: 'en', langToggle: '中文', selectionTitle: 'Please Select a Library',
                mainTitle: libName => `Amateur Radio ${libName} Quiz`,
                seqButton: 'Sequential Practice', examButton: 'Simulated Exam', practiceWrongButton: c => `Practice Mistakes (${c})`,
                viewAllButton: 'View Question Bank', viewWrongButton: c => `View Mistakes (${c})`,
                resetWrongButton: 'Clear Mistake Log', changeLibraryButton: 'Change Library',
                loading: 'Loading question bank...', loadSuccess: c => `Successfully loaded ${c} questions.`,
                loadFail: file => `<strong>Failed to load '${file}'!</strong><br>Please ensure the file exists in the same directory.`,
                statsAnswered: c => `Answered: ${c}`, statsRemaining: c => `Remaining: ${c}`,
                statsCorrect: c => `Correct: ${c}`, statsIncorrect: c => `Incorrect: ${c}`,
                singleChoice: '[Single Choice]', multiChoice: '[Multiple Choice]',
                checkAnswer: 'Check Answer', nextQuestion: 'Next Question',
                examPrev: 'Previous', examNext: 'Next', examSubmit: 'Submit',
                confirmSubmit: 'Are you sure you want to submit the exam?',
                timeRemaining: 'Time Remaining',
                examResultTitle: 'Exam Result', resultPass: 'Pass', resultFail: 'Fail',
                resultDetails: (score, total, correct, incorrect, time) => `Score: ${score}/${total}<br>Correct: ${correct} | Incorrect: ${incorrect}<br>Time Spent: ${time}`,
                correct: 'Correct!', incorrect: ans => `Incorrect! The correct answer is: <strong>${ans}</strong>`,
                quizComplete: c => `Practice complete! You attempted ${c} questions.`,
                allQuestionsTitle: 'Full Question Bank', wrongQuestionsTitle: 'My Mistakes',
                emptyList: 'Nothing to show here!', backToMenu: 'Back to Menu', practiceBackButton: 'Back to Menu',
                correctAnswerLabel: 'Correct Answer',
                confirmReset: 'Are you sure you want to clear the mistake log for the current library? This cannot be undone.',
                resetSuccess: 'Mistake log has been cleared.',
                noWrongQuestions: 'No mistakes to practice!', noQuestions: 'No questions to practice!',
                notEnoughQuestions: total => `Not enough questions in the library for a simulated exam (requires ${total}).`
            }
        };

        // --- DOM 元素 ---
        const allViews = document.querySelectorAll('.view');
        const langSwitcher = document.getElementById('lang-switcher');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const examTimerDisplay = document.getElementById('exam-timer');

        // --- 状态变量 ---
        let allQuestions = [], currentQuestions = [], wrongQuestionIds = new Set();
        let currentQuestionIndex = 0, correctCount = 0, incorrectCount = 0;
        let currentMode = null, examTimer = null, remainingTime = 0, examAnswers = new Map();
        let currentLang = 'zh', currentLibraryKey = null;
        const LANG_KEY = 'amateurRadioQuizLang', LAST_LIBRARY_KEY = 'amateurRadioLastLibrary', WRONG_QUESTIONS_KEY_PREFIX = 'amateurRadioWrongQuestions_';

        // --- 核心函数 ---
        function showView(viewToShow) {
            allViews.forEach(v => v.style.display = 'none');
            viewToShow.style.display = 'block';
        }

        function setLanguage(lang, isInitial = false) {
            currentLang = lang;
            const t = translations[lang];
            document.documentElement.lang = t.lang;
            document.title = t.selectionTitle;
            langSwitcher.textContent = t.langToggle;
            document.getElementById('selection-title').textContent = t.selectionTitle;
            document.querySelectorAll('#library-selection-view .btn').forEach(btn => {
                btn.textContent = LIBRARIES[btn.dataset.key].name[lang];
            });
            if (currentLibraryKey) {
                document.title = t.mainTitle(LIBRARIES[currentLibraryKey].name[lang]);
                document.getElementById('main-title').textContent = t.mainTitle(LIBRARIES[currentLibraryKey].name[lang]);
                document.getElementById('start-sequential-btn').textContent = t.seqButton;
                document.getElementById('start-exam-btn').textContent = t.examButton;
                document.getElementById('reset-wrong-btn').textContent = t.resetWrongButton;
                document.getElementById('view-all-btn').textContent = t.viewAllButton;
                document.getElementById('change-library-btn').textContent = t.changeLibraryButton;
                updateWrongButtons();
                if (document.getElementById('quiz-area').style.display === 'block' && currentMode !== 'exam') {
                    updateStatsDisplay();
                }
            }
            document.getElementById('check-btn').textContent = t.checkAnswer;
            document.getElementById('next-btn').textContent = t.nextQuestion;
            document.getElementById('exam-prev-btn').textContent = t.examPrev;
            document.getElementById('exam-next-btn').textContent = t.examNext;
            document.getElementById('exam-submit-btn').textContent = t.examSubmit;
            document.getElementById('back-to-menu-btn').textContent = t.backToMenu;
            document.getElementById('practice-back-btn').textContent = t.practiceBackButton;
            document.getElementById('result-back-btn').textContent = t.backToMenu;
            document.getElementById('result-title').textContent = t.examResultTitle;
            const statusMessage = document.getElementById('status-message');
            if (!isInitial && statusMessage.textContent && !statusMessage.innerHTML.includes('<strong>')) {
                if (allQuestions.length > 0) statusMessage.textContent = t.loadSuccess(allQuestions.length);
            }
        }

        function selectLibrary(key) {
            currentLibraryKey = key;
            localStorage.setItem(LAST_LIBRARY_KEY, key);
            allQuestions = [];
            setLanguage(currentLang);
            document.querySelectorAll('#main-view .btn').forEach(b => b.disabled = true);
            document.getElementById('reset-wrong-btn').disabled = false;
            document.getElementById('change-library-btn').disabled = false;
            showView(document.getElementById('main-view'));
            loadWrongQuestions();
            loadQuestions();
        }

        function loadWrongQuestions() {
            const key = WRONG_QUESTIONS_KEY_PREFIX + currentLibraryKey;
            wrongQuestionIds = new Set(JSON.parse(localStorage.getItem(key) || '[]'));
            updateWrongButtons();
        }

        function saveWrongQuestions() {
            const key = WRONG_QUESTIONS_KEY_PREFIX + currentLibraryKey;
            localStorage.setItem(key, JSON.stringify(Array.from(wrongQuestionIds)));
            updateWrongButtons();
        }
        
        function updateWrongButtons() {
            const count = wrongQuestionIds.size;
            const t = translations[currentLang];
            document.getElementById('start-wrong-btn').textContent = t.practiceWrongButton(count);
            document.getElementById('view-wrong-btn').textContent = t.viewWrongButton(count);
            document.getElementById('start-wrong-btn').disabled = count === 0;
            document.getElementById('view-wrong-btn').disabled = count === 0;
        }

        async function loadQuestions() {
            const statusMessage = document.getElementById('status-message');
            const t = translations[currentLang];
            const library = LIBRARIES[currentLibraryKey];
            statusMessage.textContent = t.loading;
            try {
                const response = await fetch(library.file);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const originalQuestions = await response.json();
                
                // ***** DATA TRANSFORMATION FOR OPTION RANDOMIZATION *****
                allQuestions = originalQuestions.map(q => {
                    const optionsArray = Object.keys(q.Options).map(key => ({
                        text: q.Options[key],
                        isCorrect: q.TrueAnswer.includes(key)
                    }));
                    return { ...q, shufflableOptions: optionsArray };
                });

                statusMessage.textContent = t.loadSuccess(allQuestions.length);
                document.getElementById('start-sequential-btn').disabled = false;
                document.getElementById('start-exam-btn').disabled = false;
                document.getElementById('view-all-btn').disabled = false;
            } catch (error) {
                statusMessage.innerHTML = t.loadFail(library.file);
                console.error("Failed to load questions:", error);
            }
        }

        function updateStatsDisplay() {
            const t = translations[currentLang];
            const answeredCount = correctCount + incorrectCount;
            const remainingCount = currentQuestions.length - answeredCount;
            document.getElementById('stats-answered').textContent = t.statsAnswered(answeredCount);
            document.getElementById('stats-remaining').textContent = t.statsRemaining(remainingCount);
            document.getElementById('stats-correct').textContent = t.statsCorrect(correctCount);
            document.getElementById('stats-incorrect').textContent = t.statsIncorrect(incorrectCount);
        }

        function startQuiz(mode) {
            currentMode = mode;
            const t = translations[currentLang];
            currentQuestionIndex = 0;
            correctCount = 0;
            incorrectCount = 0;
            
            const practiceActions = document.getElementById('practice-actions');
            const examActions = document.getElementById('exam-actions');
            const progressContainer = document.getElementById('progress-container');
            const statsContainer = document.getElementById('stats-container');

            if (mode === 'exam') {
                if (allQuestions.length < EXAM_CONFIG.TOTAL_QUESTIONS) {
                    alert(t.notEnoughQuestions(EXAM_CONFIG.TOTAL_QUESTIONS));
                    return;
                }
                currentQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, EXAM_CONFIG.TOTAL_QUESTIONS);
                examAnswers.clear();
                practiceActions.classList.add('hidden');
                examActions.classList.remove('hidden');
                progressContainer.classList.add('hidden');
                statsContainer.classList.add('hidden');
                examTimerDisplay.classList.remove('hidden');
                startExamTimer();
            } else {
                examTimerDisplay.classList.add('hidden');
                practiceActions.classList.remove('hidden');
                examActions.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                statsContainer.classList.remove('hidden');
                stopExamTimer();
                if (mode === 'sequential') {
                    currentQuestions = [...allQuestions];
                } else { // 'wrong'
                    if (wrongQuestionIds.size === 0) { alert(t.noWrongQuestions); return; }
                    currentQuestions = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
                }
            }

            if (currentQuestions.length === 0) { alert(t.noQuestions); return; }
            
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            updateStatsDisplay();
            showView(document.getElementById('quiz-area'));
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                if (currentMode !== 'exam') showSummary();
                return;
            }
            const t = translations[currentLang];
            document.getElementById('feedback').classList.add('hidden');
            
            if (currentMode !== 'exam') {
                document.getElementById('check-btn').classList.remove('hidden');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('check-btn').disabled = false;
                const percentage = ((currentQuestionIndex) / currentQuestions.length) * 100;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${Math.round(percentage)}%`;
            } else {
                document.getElementById('exam-prev-btn').disabled = currentQuestionIndex === 0;
                document.getElementById('exam-next-btn').disabled = currentQuestionIndex === currentQuestions.length - 1;
            }

            const question = currentQuestions[currentQuestionIndex];
            const isMultiChoice = question.TrueAnswer.length > 1;
            const questionTypeTag = isMultiChoice ? t.multiChoice : t.singleChoice;
            document.getElementById('question').innerHTML = `<span class="question-type">${questionTypeTag}</span>${currentQuestionIndex + 1}. ${question.Question}`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            // ***** OPTION SHUFFLING LOGIC *****
            let optionsToDisplay = [...question.shufflableOptions];
            if (currentMode !== 'view') { // Don't shuffle when just viewing
                optionsToDisplay.sort(() => Math.random() - 0.5);
            }
            
            const savedAnswerTexts = currentMode === 'exam' ? (examAnswers.get(question.J_ID) || []) : [];

            optionsToDisplay.forEach((opt, index) => {
                const displayLetter = String.fromCharCode(65 + index);
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option';
                const input = document.createElement('input');
                input.type = isMultiChoice ? 'checkbox' : 'radio';
                input.name = 'option';
                input.value = opt.text; // Use text as value for exam answer saving
                input.dataset.isCorrect = opt.isCorrect; // Store correctness in dataset
                
                if (currentMode === 'exam' && savedAnswerTexts.includes(opt.text)) {
                    input.checked = true;
                }

                optionLabel.appendChild(input);
                optionLabel.appendChild(document.createTextNode(` ${displayLetter}. ${opt.text}`));
                optionsDiv.appendChild(optionLabel);
            });
        }

        function saveExamAnswer() {
            if (currentMode !== 'exam') return;
            const question = currentQuestions[currentQuestionIndex];
            const selectedTexts = Array.from(document.querySelectorAll('#options input:checked')).map(i => i.value);
            examAnswers.set(question.J_ID, selectedTexts);
        }

        function checkAnswer() { // Only for practice modes
            const t = translations[currentLang];
            const allInputs = document.querySelectorAll('#options input');
            
            // Check if every input's checked state matches its correctness
            const isFullyCorrect = Array.from(allInputs).every(input => input.checked === (input.dataset.isCorrect === 'true'));

            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.classList.remove('hidden');
            const question = currentQuestions[currentQuestionIndex];

            if (isFullyCorrect) {
                feedbackDiv.textContent = t.correct;
                feedbackDiv.className = 'feedback-correct';
                correctCount++;
                if (wrongQuestionIds.has(question.J_ID)) wrongQuestionIds.delete(question.J_ID);
            } else {
                feedbackDiv.innerHTML = t.incorrect(question.TrueAnswer);
                feedbackDiv.className = 'feedback-incorrect';
                incorrectCount++;
                wrongQuestionIds.add(question.J_ID);
            }
            updateStatsDisplay();
            saveWrongQuestions();
            
            // Highlight based on the data attribute, not a fixed answer string
            allInputs.forEach(input => {
                const label = input.parentElement;
                if (input.dataset.isCorrect === 'true') {
                    label.classList.add('correct');
                } else if (input.checked) {
                    label.classList.add('incorrect');
                }
                input.disabled = true;
            });

            document.getElementById('check-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function showSummary() {
            showView(document.getElementById('main-view'));
            document.getElementById('status-message').textContent = translations[currentLang].quizComplete(currentQuestions.length);
        }

        function startExamTimer() {
            stopExamTimer();
            remainingTime = EXAM_CONFIG.DURATION;
            const t = translations[currentLang];
            const updateTimer = () => {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                examTimerDisplay.textContent = `${t.timeRemaining}: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (remainingTime <= 0) {
                    submitExam(true);
                }
                remainingTime--;
            };
            updateTimer();
            examTimer = setInterval(updateTimer, 1000);
        }

        function stopExamTimer() {
            clearInterval(examTimer);
            examTimer = null;
        }

        function submitExam(isAuto = false) {
            const t = translations[currentLang];
            if (!isAuto && !confirm(t.confirmSubmit)) return;
            
            stopExamTimer();
            let finalCorrect = 0;
            
            currentQuestions.forEach(q => {
                const savedTexts = examAnswers.get(q.J_ID) || [];
                const correctTexts = q.shufflableOptions.filter(opt => opt.isCorrect).map(opt => opt.text);
                
                const isAnswerCorrect = savedTexts.length === correctTexts.length && savedTexts.sort().join(',') === correctTexts.sort().join(',');

                if (isAnswerCorrect) {
                    finalCorrect++;
                    if (wrongQuestionIds.has(q.J_ID)) wrongQuestionIds.delete(q.J_ID);
                } else {
                    wrongQuestionIds.add(q.J_ID);
                }
            });

            saveWrongQuestions();

            const isPass = finalCorrect >= EXAM_CONFIG.PASS_SCORE;
            const timeSpent = EXAM_CONFIG.DURATION - (remainingTime + 1);
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const resultStatus = document.getElementById('result-status');
            resultStatus.textContent = isPass ? t.resultPass : t.resultFail;
            resultStatus.className = `result-status ${isPass ? 'pass' : 'fail'}`;
            
            document.getElementById('result-details').innerHTML = t.resultDetails(
                finalCorrect, EXAM_CONFIG.TOTAL_QUESTIONS, finalCorrect, EXAM_CONFIG.TOTAL_QUESTIONS - finalCorrect, timeStr
            );
            
            showView(document.getElementById('exam-result-view'));
        }

        function displayListView(mode) {
            const t = translations[currentLang];
            let questionsToDisplay;
            const listViewTitle = document.getElementById('list-view-title');
            if (mode === 'all') {
                listViewTitle.textContent = t.allQuestionsTitle;
                questionsToDisplay = allQuestions;
            } else {
                listViewTitle.textContent = t.wrongQuestionsTitle;
                questionsToDisplay = allQuestions.filter(q => wrongQuestionIds.has(q.J_ID));
            }
            const listViewContent = document.getElementById('list-view-content');
            if (questionsToDisplay.length === 0) {
                listViewContent.innerHTML = `<p style="text-align:center; color:#777; padding: 20px 0;">${t.emptyList}</p>`;
            } else {
                listViewContent.innerHTML = questionsToDisplay.map((q, index) => {
                    const isMultiChoice = q.TrueAnswer.length > 1;
                    const questionTypeTag = isMultiChoice ? t.multiChoice : t.singleChoice;
                    const optionsHtml = Object.entries(q.Options).map(([key, value]) => `<p>${key}. ${value}</p>`).join('');
                    return `<div class="list-item"><p class="list-item-question"><strong>${index + 1}. </strong><span class="question-type">${questionTypeTag}</span>${q.Question}</p><div class="list-item-options">${optionsHtml}</div><p class="list-item-answer">${t.correctAnswerLabel}: ${q.TrueAnswer}</p></div>`;
                }).join('');
            }
            showView(document.getElementById('list-view'));
        }

        // --- 事件监听器 ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem(LANG_KEY) || 'zh';
            setLanguage(savedLang, true);
            const savedLibrary = localStorage.getItem(LAST_LIBRARY_KEY);
            if (savedLibrary && LIBRARIES[savedLibrary]) {
                selectLibrary(savedLibrary);
            } else {
                showView(document.getElementById('library-selection-view'));
            }
        });

        langSwitcher.addEventListener('click', () => {
            const newLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem(LANG_KEY, newLang);
            setLanguage(newLang);
        });

        document.querySelectorAll('#library-selection-view .btn').forEach(btn => {
            btn.addEventListener('click', () => selectLibrary(btn.dataset.key));
        });

        document.getElementById('change-library-btn').addEventListener('click', () => {
            currentLibraryKey = null;
            localStorage.removeItem(LAST_LIBRARY_KEY);
            showView(document.getElementById('library-selection-view'));
        });

        document.getElementById('start-sequential-btn').addEventListener('click', () => startQuiz('sequential'));
        document.getElementById('start-exam-btn').addEventListener('click', () => startQuiz('exam'));
        document.getElementById('start-wrong-btn').addEventListener('click', () => startQuiz('wrong'));
        document.getElementById('view-all-btn').addEventListener('click', () => displayListView('all'));
        document.getElementById('view-wrong-btn').addEventListener('click', () => displayListView('wrong'));
        document.getElementById('back-to-menu-btn').addEventListener('click', () => showView(document.getElementById('main-view')));
        document.getElementById('practice-back-btn').addEventListener('click', () => showView(document.getElementById('main-view')));
        document.getElementById('result-back-btn').addEventListener('click', () => showView(document.getElementById('main-view')));

        document.getElementById('reset-wrong-btn').addEventListener('click', () => {
            const t = translations[currentLang];
            if (confirm(t.confirmReset)) {
                wrongQuestionIds.clear();
                saveWrongQuestions();
                alert(t.resetSuccess);
            }
        });

        document.getElementById('check-btn').addEventListener('click', checkAnswer);
        document.getElementById('next-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            displayQuestion();
        });

        document.getElementById('options').addEventListener('change', saveExamAnswer);
        document.getElementById('exam-prev-btn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        });
        document.getElementById('exam-next-btn').addEventListener('click', () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        });
        document.getElementById('exam-submit-btn').addEventListener('click', () => submitExam(false));
    </script>
</body>
</html>